<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CedarSim Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #2c3e50;
        }

        .header {
            background: linear-gradient(135deg, #2E86AB, #A23B72);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 300;
        }

        .controls {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .control-group label {
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
        }

        select, input, button {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        button {
            background: #2E86AB;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #1f5f7a;
        }

        .main-content {
            display: flex;
            height: calc(100vh - 140px);
        }

        .hospital-layout {
            flex: 1;
            background: white;
            margin: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .hospital-layout h2 {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
            margin: 0;
        }

        .levels-container {
            padding: 1rem;
        }

        .level {
            margin-bottom: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }

        .level-header {
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 1px solid #e0e0e0;
        }

        .pars-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 1rem;
        }

        .par-box {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 80px;
            text-align: center;
            position: relative;
        }

        .par-box:hover {
            background: #e3f2fd;
            border-color: #2E86AB;
        }

        .par-box.selected {
            background: #2E86AB;
            color: white;
            border-color: #1f5f7a;
        }

        .par-box.connected {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .sku-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .sku-indicator.has-sku {
            background: #4caf50;
            color: white;
        }

        .sku-indicator.no-sku {
            background: #e0e0e0;
            color: #999;
        }

        .par-name {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .par-stats {
            font-size: 0.7rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .par-stats.selected {
            color: #e0e0e0;
        }

        .analysis-panel {
            width: 400px;
            background: white;
            margin: 1rem 1rem 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .analysis-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
        }

        .analysis-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .chart-container {
            height: 300px;
            margin-bottom: 1rem;
        }

        .sku-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .info-label {
            font-weight: 500;
            color: #666;
        }

        .info-value {
            color: #2c3e50;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem;
        }

        .perpetual {
            background: #e3f2fd !important;
            border-color: #2196f3 !important;
        }

        .perpetual .par-name {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè• CedarSim Inventory Dashboard</h1>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="skuSelect">Select SKU:</label>
            <select id="skuSelect">
                <option value="">Select a SKU</option>
            </select>
        </div>
        <div class="control-group">
            <label for="timeRange">Time Range (weeks):</label>
            <input type="number" id="timeRange" value="52" min="1" max="104">
        </div>
        <div class="control-group">
            <label>&nbsp;</label>
            <button id="runSimulation">‚ñ∂Ô∏è Run Simulation</button>
        </div>
    </div>

    <div class="main-content">
        <div class="hospital-layout">
            <h2>Hospital Levels</h2>
            <div class="levels-container" id="levelsContainer">
                <div class="loading">Loading hospital layout...</div>
            </div>
        </div>

        <div class="analysis-panel">
            <div class="analysis-header">
                <h3>SKU Analysis</h3>
            </div>
            <div class="analysis-content">
                <div id="skuInfo" class="sku-info" style="display: none;">
                    <div class="info-row">
                        <span class="info-label">Selected SKU:</span>
                        <span class="info-value" id="selectedSku">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Available in:</span>
                        <span class="info-value" id="connectedPars">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Total Demand:</span>
                        <span class="info-value" id="totalDemand">-</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="inventoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let hospitalLayout = {};
        let skuConnections = {};
        let selectedSku = null;
        let inventoryChart = null;

        // Initialize the dashboard
        async function init() {
            try {
                await loadHospitalLayout();
                await loadSKUs();
                setupEventListeners();
                // Set default SKU if available
                const skuSelect = document.getElementById('skuSelect');
                if (skuSelect.options.length > 1) {
                    skuSelect.value = skuSelect.options[1].value;
                    selectSKU(skuSelect.value);
                }
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showError('Failed to initialize dashboard');
            }
        }

        // Load hospital layout data
        async function loadHospitalLayout() {
            const response = await fetch('/api/hospital-layout');
            if (!response.ok) throw new Error('Failed to load hospital layout');
            
            hospitalLayout = await response.json();
            renderHospitalLayout();
        }

        // Load SKU data
        async function loadSKUs() {
            const response = await fetch('/api/skus');
            if (!response.ok) throw new Error('Failed to load SKUs');
            
            const skus = await response.json();
            populateSKUSelect(skus);
            
            // Load SKU connections for indicators
            await loadSKUConnections();
        }

        // Load SKU connections
        async function loadSKUConnections() {
            try {
                const response = await fetch('/api/sku-connections');
                if (response.ok) {
                    skuConnections = await response.json();
                }
            } catch (error) {
                console.error('Error loading SKU connections:', error);
            }
        }

        // Render hospital layout
        function renderHospitalLayout() {
            const container = document.getElementById('levelsContainer');
            container.innerHTML = '';

            Object.entries(hospitalLayout).forEach(([levelName, levelData]) => {
                const levelDiv = document.createElement('div');
                levelDiv.className = 'level';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'level-header';
                headerDiv.textContent = `${levelName}: ${levelData.name}`;
                levelDiv.appendChild(headerDiv);

                const parsDiv = document.createElement('div');
                parsDiv.className = 'pars-container';
                
                levelData.pars_data.forEach(par => {
                    const parBox = document.createElement('div');
                    parBox.className = 'par-box';
                    if (par.name === 'PERPETUAL') {
                        parBox.classList.add('perpetual');
                    }
                    
                    // Store original SKU count for reset functionality
                    parBox.dataset.originalSkuCount = par.sku_count;
                    
                    parBox.innerHTML = `
                        <div class="sku-indicator no-sku">‚óã</div>
                        <div class="par-name">${par.name}</div>
                        <div class="par-stats">${par.sku_count} SKUs</div>
                    `;
                    
                    parBox.addEventListener('click', () => selectPAR(par.name));
                    parsDiv.appendChild(parBox);
                });
                
                levelDiv.appendChild(parsDiv);
                container.appendChild(levelDiv);
            });
        }

        // Populate SKU select dropdown
        function populateSKUSelect(skus) {
            const select = document.getElementById('skuSelect');
            select.innerHTML = '<option value="">Select a SKU</option>';
            
            skus.forEach(sku => {
                const option = document.createElement('option');
                option.value = sku.sku_id;
                option.textContent = `${sku.sku_id} - ${sku.name || 'Unknown'} (${sku.par_count} PARs)`;
                select.appendChild(option);
            });
        }

        // Select PAR (for highlighting only in SKU-centric approach)
        function selectPAR(parName) {
            // Remove previous selections
            document.querySelectorAll('.par-box').forEach(box => {
                box.classList.remove('selected');
            });
            
            // Add selection to clicked PAR
            event.target.closest('.par-box').classList.add('selected');
        }

        // Select SKU
        async function selectSKU(skuId) {
            if (!skuId) {
                // Reset display when no SKU is selected
                resetSKUDisplay();
                return;
            }
            
            selectedSku = skuId;
            await loadSKUDetails(skuId);
            await loadInventoryTimeline(skuId);
            updateSKUIndicators(skuId);
        }

        // Reset SKU display
        function resetSKUDisplay() {
            selectedSku = null;
            
            // Hide SKU info panel
            document.getElementById('skuInfo').style.display = 'none';
            
            // Reset all PAR boxes to show total SKU counts
            document.querySelectorAll('.par-box').forEach(box => {
                const indicator = box.querySelector('.sku-indicator');
                const stats = box.querySelector('.par-stats');
                
                // Reset indicator
                indicator.className = 'sku-indicator no-sku';
                indicator.textContent = '‚óã';
                
                // Reset stats to show total SKU count
                const originalSkuCount = box.dataset.originalSkuCount || '0';
                stats.textContent = `${originalSkuCount} SKUs`;
            });
            
            // Remove all highlights
            document.querySelectorAll('.par-box').forEach(box => {
                box.classList.remove('connected', 'selected');
            });
            
            // Clear chart
            if (inventoryChart) {
                inventoryChart.destroy();
                inventoryChart = null;
            }
        }

        // Load SKU details
        async function loadSKUDetails(skuId) {
            try {
                const response = await fetch(`/api/sku/${skuId}`);
                if (!response.ok) throw new Error('Failed to load SKU details');
                
                const skuData = await response.json();
                
                document.getElementById('selectedSku').textContent = skuId;
                document.getElementById('connectedPars').textContent = `${skuData.connection_count} PARs + Perpetual`;
                document.getElementById('totalDemand').textContent = 
                    skuData.par_skus.reduce((sum, par) => sum + par.demand_rate, 0).toFixed(1);
                
                document.getElementById('skuInfo').style.display = 'block';
                
                // Highlight connected PARs
                highlightConnectedPARs(skuData.par_skus);
                
            } catch (error) {
                console.error('Error loading SKU details:', error);
            }
        }

        // Update SKU indicators on PAR boxes
        function updateSKUIndicators(skuId) {
            // Reset all indicators and stats
            document.querySelectorAll('.par-box').forEach(box => {
                const indicator = box.querySelector('.sku-indicator');
                const stats = box.querySelector('.par-stats');
                
                // Reset indicator
                indicator.className = 'sku-indicator no-sku';
                indicator.textContent = '‚óã';
                
                // Reset stats to show total SKU count
                const parName = box.querySelector('.par-name').textContent;
                const originalSkuCount = box.dataset.originalSkuCount || '0';
                stats.textContent = `${originalSkuCount} SKUs`;
            });
            
            // Update indicators and stats for connected PARs
            if (skuConnections[skuId]) {
                const skuData = skuConnections[skuId];
                
                // Mark perpetual
                const perpetualBox = Array.from(document.querySelectorAll('.par-box')).find(box => 
                    box.querySelector('.par-name').textContent === 'PERPETUAL'
                );
                if (perpetualBox) {
                    const indicator = perpetualBox.querySelector('.sku-indicator');
                    const stats = perpetualBox.querySelector('.par-stats');
                    
                    indicator.className = 'sku-indicator has-sku';
                    indicator.textContent = '‚óè';
                    
                    // Update stats to show specific SKU level
                    const perpetualSku = skuData.perpetual_sku;
                    if (perpetualSku) {
                        stats.textContent = `Level: ${perpetualSku.current_level.toFixed(1)}`;
                    }
                }
                
                // Mark PARs
                skuData.par_skus.forEach(parSku => {
                    const parBox = Array.from(document.querySelectorAll('.par-box')).find(box => 
                        box.querySelector('.par-name').textContent === parSku.location_id
                    );
                    if (parBox) {
                        const indicator = parBox.querySelector('.sku-indicator');
                        const stats = parBox.querySelector('.par-stats');
                        
                        indicator.className = 'sku-indicator has-sku';
                        indicator.textContent = '‚óè';
                        
                        // Update stats to show specific SKU level
                        stats.textContent = `Level: ${parSku.current_level.toFixed(1)}`;
                    }
                });
            }
        }

        // Highlight connected PARs
        function highlightConnectedPARs(parSkus) {
            // Remove previous highlights
            document.querySelectorAll('.par-box').forEach(box => {
                box.classList.remove('connected');
            });
            
            // Highlight connected PARs
            parSkus.forEach(parSku => {
                const parBoxes = document.querySelectorAll('.par-box');
                parBoxes.forEach(box => {
                    if (box.querySelector('.par-name').textContent === parSku.location_id) {
                        box.classList.add('connected');
                    }
                });
            });
        }

        // Load inventory timeline
        async function loadInventoryTimeline(skuId) {
            try {
                const weeks = document.getElementById('timeRange').value;
                const response = await fetch(`/api/sku/${skuId}/timeline?weeks=${weeks}`);
                if (!response.ok) throw new Error('Failed to load timeline');
                
                const timeline = await response.json();
                renderInventoryChart(timeline);
                
            } catch (error) {
                console.error('Error loading timeline:', error);
            }
        }

        // Render inventory chart
        function renderInventoryChart(timeline) {
            const ctx = document.getElementById('inventoryChart').getContext('2d');
            
            if (inventoryChart) {
                inventoryChart.destroy();
            }
            
            const datasets = [
                {
                    label: 'Perpetual',
                    data: timeline.perpetual,
                    borderColor: '#2196f3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.1
                }
            ];
            
            // Add PAR datasets
            Object.entries(timeline.pars).forEach(([parId, data], index) => {
                const colors = ['#4caf50', '#ff9800', '#9c27b0', '#f44336', '#00bcd4'];
                datasets.push({
                    label: parId,
                    data: data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    tension: 0.1
                });
            });
            
            inventoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeline.weeks.map(w => `Week ${w}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Inventory Level'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (Weeks)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('skuSelect').addEventListener('change', (e) => {
                selectSKU(e.target.value);
            });
            
            document.getElementById('timeRange').addEventListener('change', (e) => {
                if (selectedSku) {
                    loadInventoryTimeline(selectedSku);
                }
            });
            
            document.getElementById('runSimulation').addEventListener('click', () => {
                runSimulation();
            });
        }

        // Run simulation
        async function runSimulation() {
            try {
                const weeks = document.getElementById('timeRange').value;
                const response = await fetch('/api/simulation/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ weeks: parseInt(weeks) })
                });
                
                if (!response.ok) throw new Error('Failed to run simulation');
                
                const result = await response.json();
                alert(`Simulation started: ${result.message}`);
                
            } catch (error) {
                console.error('Error running simulation:', error);
                alert('Failed to run simulation');
            }
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('levelsContainer');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
